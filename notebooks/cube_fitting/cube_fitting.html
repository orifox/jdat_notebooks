
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spectral Cube Modeling &#8212; STScI JDAT Notebooks</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/stsci_logo2.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">STScI JDAT Notebooks</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   James Webb Space Telescope Data Analysis Tool Notebooks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Cross-Instrument
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../asdf_example/asdf_example.html">
   Example of Converting a FITS File to ASDF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../background_estimation_imaging/Imaging%20Sky%20Background%20Estimation.html">
   Complex 2D Background
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
   Draft: Advanced Composite spectral model fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
   MAST Query
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
   Specviz Simple Demo
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MIRI
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
   MIRI MRS Spectroscopy of a Late M Star 1 - Running the Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
   Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
   JWST Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
   LRS Extraction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRCam
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
   Point Source Aperture Photometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRCam_photometry/NIRCam%20multiband%20photometry.html">
   NIRCam Multiband Photometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
   PSF Photometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
   NIRCam PSF-matched multiband photometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_02_calwebb.html">
   Preimaging - Calwebb
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_03_association.html">
   Creating simulated images of the JWST astrometric calibration field in the LMC
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRISS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00.%20Optimal%20extraction.html">
   Part 0: Optimal Extraction of NIRISS WFSS Spectrum
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01.%20Combine%20and%20normalize%201D%20spectra.html">
   Part 1: Combine One-Dimensional NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02.%20Cross%20correlation%20template.html">
   Part 2: Cross Correlation to Determine Redshift of NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03.%20Spatially%20resolved%20emission%20line%20map.html">
   Part 3: Spatially Resolved Emission Line Map of NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../niriss_ami_binary/1_niriss_ami_binary.html">
   NIRISS AMI simulation of binary point source AB Dor and calibrator HD37093
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../niriss_ami_binary/2_niriss_ami_binary.html">
   AMI Binary Star Notebook 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html">
   SOSS Transient Spectroscopy
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRSpec
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
   IFU Optimal Extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../optimal_extraction_dynamic/Spectral%20Extraction.html">
   NIRSpec MOS Optimal Spectral Extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
   MOS Spectroscopy of Extragalactic Field
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
   Extracting an Exoplanet Transmission Spectrum from NIRSpec BOTS Time Series Observations
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/cube_fitting/cube_fitting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/spacetelescope/jdat_notebooks/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/cube_fitting/cube_fitting.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#definitions-of-functions">
   Definitions of functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scrolling">
     Scrolling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-functions">
     Model Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-parameters">
   Model Parameters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#line-flux-from-model-parameters">
     Line Flux from Model Parameters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-and-plot-1d-spectrum-and-model-components">
     Extract and plot 1D spectrum and model components
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#input-data">
   Input data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-parameter-starting-values">
   Model Parameter Starting Values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-a-representative-spaxel">
   Fit a Representative Spaxel
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-the-entire-cube">
   Fit the Entire Cube
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#total-flux-and-reduced-chi-2-maps">
     Total flux and Reduced Chi^2 Maps
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#line-and-pah-feature-flux-maps">
     Line and PAH feature flux maps.
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
       Functions to extract line and PAH maps from model parameter cube
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
       H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extract-and-model-cube-sub-regions">
   Extract and model cube sub-regions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#make-spectral-region-masks">
     Make spectral region masks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-spectra-from-mask-regions">
     Extract spectra from mask regions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#save-spectra-to-files">
     Save spectra to files
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-spectra-of-regions">
     Fit spectra of regions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generic-model-components">
       Generic model components
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#spiral-arm-spectral-fit">
       Spiral arm spectral fit
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#h2-strongest-region-spectral-fit">
       H2-strongest region spectral fit
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#nucleus-spectral-fit">
       Nucleus spectral fit
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary-plot">
   Summary Plot
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Spectral Cube Modeling</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#definitions-of-functions">
   Definitions of functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scrolling">
     Scrolling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-functions">
     Model Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-parameters">
   Model Parameters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#line-flux-from-model-parameters">
     Line Flux from Model Parameters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-and-plot-1d-spectrum-and-model-components">
     Extract and plot 1D spectrum and model components
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#input-data">
   Input data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-parameter-starting-values">
   Model Parameter Starting Values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-a-representative-spaxel">
   Fit a Representative Spaxel
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-the-entire-cube">
   Fit the Entire Cube
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#total-flux-and-reduced-chi-2-maps">
     Total flux and Reduced Chi^2 Maps
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#line-and-pah-feature-flux-maps">
     Line and PAH feature flux maps.
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
       Functions to extract line and PAH maps from model parameter cube
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
       H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extract-and-model-cube-sub-regions">
   Extract and model cube sub-regions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#make-spectral-region-masks">
     Make spectral region masks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extract-spectra-from-mask-regions">
     Extract spectra from mask regions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#save-spectra-to-files">
     Save spectra to files
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fit-spectra-of-regions">
     Fit spectra of regions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generic-model-components">
       Generic model components
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#spiral-arm-spectral-fit">
       Spiral arm spectral fit
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#h2-strongest-region-spectral-fit">
       H2-strongest region spectral fit
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#nucleus-spectral-fit">
       Nucleus spectral fit
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary-plot">
   Summary Plot
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="spectral-cube-modeling">
<h1>Spectral Cube Modeling<a class="headerlink" href="#spectral-cube-modeling" title="Permalink to this headline">¶</a></h1>
<p><strong>Use case:</strong> Extracting spatial-spectral features of interest from the cube of data and measuring their
attributes.  Create line and PAH maps from the model parameters map.<br>
<strong>Data:</strong> SL1 and SL2 spectral cubes generated using CUBISM, from Spitzer IRS spectral mapping observations of the center of nearby galaxy Messier 58.<br>
<strong>Tools:</strong> astropy, specutils, dust-extinction, matplotlib.<br>
<strong>Cross-intrument:</strong> NIRSpec, MIRI.<br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Analysis of JWST spectral cubes requires extracting spatial-spectral features of interest and measuring their
attributes. Here, we demonstrate 1-D spectral modeling applied to an individual spaxel, 900 spaxels in a cube, and spectra summed over spatial regions. Analysis of large JWST spectral data cubes can be computationally expensive, depending on number of spaxels modeled and number of free model parameters. This task can be made manageable by focusing on spatial sub-regions of interest or by minimizing model complexity.  Sub-regions in the cube are selected by location and line ratios. The spaxels in these regions are then summed and modeled with a combination of continuum, emission line, polycyclic aromatic hydrocarbon (PAH), and silicate dust features. Best-fitting model spectra are fit using the lmfit package, utilizing a Levenberg-Marquardt least-squares method.</p>
</div>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><em>time</em> for timing</p></li>
<li><p><em>multiprocessing.Pool</em> for parallel processing on cube spaxels</p></li>
<li><p><em>pickle</em> for pickling and unpickling IO to multiprocessing pools</p></li>
<li><p><em>numpy</em> for array processing and math</p></li>
<li><p><em>matplotlib.pyplot</em> for plotting images and spectra</p></li>
<li><p><em><a class="reference external" href="http://astropy.io">astropy.io</a></em> for reading and writing FITS cubes and images</p></li>
<li><p><em>astropy.visualization</em> to construct RGB images</p></li>
<li><p><em>lmfit</em> Levenberg-Marquart fitting package for model-fitting</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">loadtxt</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">arange</span><span class="p">,</span> <span class="n">interp</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> 
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">make_lupton_rgb</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span>

<span class="kn">import</span> <span class="nn">lmfit</span>
<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Minimizer</span><span class="p">,</span> <span class="n">Parameters</span>
<span class="kn">from</span> <span class="nn">lmfit.model</span> <span class="kn">import</span> <span class="n">save_modelresult</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="definitions-of-functions">
<h2>Definitions of functions<a class="headerlink" href="#definitions-of-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="scrolling">
<h3>Scrolling<a class="headerlink" href="#scrolling" title="Permalink to this headline">¶</a></h3>
<p>Limit scrolling in cell output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%javascript</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">OutputArea</span><span class="p">.</span><span class="nx">auto_scroll_threshold</span><span class="o">=</span><span class="mf">70</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">IPython.OutputArea.auto_scroll_threshold=70;
</script></div>
</div>
</div>
<div class="section" id="model-functions">
<h3>Model Functions<a class="headerlink" href="#model-functions" title="Permalink to this headline">¶</a></h3>
<p>A variety of emission line, continuum and extinction models for spectral fitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Modelcero</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple model of 0 to initialize some models&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">*</span><span class="n">x</span>

<span class="c1">#powerlaw, zblackbody, gaussian and drude functions wrap existing astropy models.</span>
<span class="c1">#lmfit requires wavelength (x) to be passed as function parameter.</span>

<span class="k">def</span> <span class="nf">powerlaw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;power law function (c1*nu^c2) normalized at 1 micron, with positive index convention&quot;&quot;&quot;</span>
    <span class="n">x0</span><span class="o">=</span><span class="mf">1.0</span>  <span class="c1">#Normalize at  1 micron</span>
    <span class="n">c2</span><span class="o">=-</span><span class="n">c2</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">PowerLaw1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">c2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">zblackbody</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;black body function&quot;&quot;&quot;</span>
    <span class="n">xs</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="o">/</span><span class="n">OnePlusZ</span>
    <span class="n">bb</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">BlackBody</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bb</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;1-d gaussian&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="n">xcen</span><span class="p">,</span><span class="n">std</span><span class="p">)</span>   

<span class="k">def</span> <span class="nf">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;dust emission&quot;&quot;&quot;</span>
    <span class="n">FWHM</span><span class="o">=</span><span class="n">peakx</span><span class="o">*</span><span class="n">frac_FWHM</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Drude1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="n">peakx</span><span class="p">,</span><span class="n">FWHM</span><span class="p">)</span>

<span class="c1">#pahdust and sidust functions do not exist in astropy</span>

<span class="k">def</span> <span class="nf">pahdust</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">amplitude_76</span><span class="p">,</span> <span class="n">amplitude_113</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PAH dust emission&quot;&quot;&quot;</span>
    
    <span class="c1">#Ionized PAH features</span>
    <span class="n">PAH_peakx</span><span class="o">=</span>     <span class="p">[</span> <span class="mf">5.27</span><span class="p">,</span> <span class="mf">5.70</span><span class="p">,</span> <span class="mf">6.22</span><span class="p">,</span> <span class="mf">6.69</span><span class="p">,</span> <span class="mf">7.42</span><span class="p">,</span> <span class="mf">7.60</span><span class="p">,</span> <span class="mf">7.85</span><span class="p">,</span> <span class="mf">8.33</span><span class="p">,</span> <span class="mf">8.61</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.034</span><span class="p">,</span><span class="mf">0.035</span><span class="p">,</span> <span class="mf">0.030</span><span class="p">,</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.126</span><span class="p">,</span><span class="mf">0.044</span><span class="p">,</span><span class="mf">0.053</span><span class="p">,</span><span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.039</span><span class="p">]</span>
    <span class="n">PAH_rel_amplitude</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.8</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span>  <span class="mf">0.6</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">PAH_amplitude</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="n">PAH_rel_amplitude</span><span class="p">:</span> <span class="n">PAH_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_76</span><span class="o">*</span><span class="p">(</span><span class="n">ampl</span><span class="o">/</span><span class="n">PAH_rel_amplitude</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
 
    <span class="c1">#Neutral PAH features</span>
    <span class="n">PAH_peakx</span><span class="o">+=</span>    <span class="p">[</span><span class="mf">10.68</span><span class="p">,</span> <span class="mf">11.23</span><span class="p">,</span><span class="mf">11.33</span><span class="p">]</span>
    <span class="n">PAH_peakx</span><span class="o">+=</span>    <span class="p">[</span><span class="mf">11.99</span><span class="p">,</span><span class="mf">12.62</span><span class="p">,</span><span class="mf">12.69</span><span class="p">,</span><span class="mf">13.48</span><span class="p">,</span><span class="mf">14.04</span><span class="p">,</span><span class="mf">14.19</span><span class="p">,</span><span class="mf">15.90</span><span class="p">,</span> <span class="mf">16.45</span><span class="p">,</span><span class="mf">17.04</span><span class="p">,</span><span class="mf">17.375</span><span class="p">,</span><span class="mf">17.87</span><span class="p">,</span><span class="mf">18.92</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.020</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span><span class="mf">0.022</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.045</span><span class="p">,</span><span class="mf">0.042</span><span class="p">,</span> <span class="mf">0.013</span><span class="p">,</span><span class="mf">0.040</span><span class="p">,</span><span class="mf">0.016</span><span class="p">,</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.020</span><span class="p">,</span><span class="mf">0.014</span><span class="p">,</span><span class="mf">0.065</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span> <span class="mf">0.016</span><span class="p">,</span><span class="mf">0.019</span><span class="p">]</span>   
    <span class="n">PAH_rel_amplitude</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">PAH_rel_amplitude</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span>  <span class="mf">0.3</span><span class="p">,</span>   <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="n">PAH_rel_amplitude</span><span class="p">:</span> <span class="n">PAH_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_113</span><span class="o">*</span><span class="p">(</span><span class="n">ampl</span><span class="o">/</span><span class="n">PAH_rel_amplitude</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="n">pahflux</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="k">for</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">,</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">PAH_peakx</span><span class="p">,</span><span class="n">PAH_frac_FWHM</span><span class="p">,</span><span class="n">PAH_amplitude</span><span class="p">):</span>
        <span class="n">pahflux</span><span class="o">=</span><span class="n">pahflux</span><span class="o">+</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ampl</span><span class="p">,</span><span class="n">peakx</span><span class="o">*</span><span class="n">OnePlusZ</span><span class="p">,</span><span class="n">frac_FWHM</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pahflux</span>    <span class="c1">#Amplitude unit</span>

<span class="k">def</span> <span class="nf">sidust</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Silicate dust emission&quot;&quot;&quot;</span>
    
    <span class="c1">#Custom extinction curve built from weighted sum of three components: </span>
    <span class="c1">#two Drude functions and an exponent 1.7 power-law.</span>
    <span class="n">d1</span><span class="o">=</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.80</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">d2</span><span class="o">=</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">11.1</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="c1">#d3=drude(x,0.40,17.0,0.40)  #Outside of wavelength range.</span>
    <span class="n">ext</span><span class="o">=</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span>  <span class="c1">#+d3</span>

    <span class="c1"># Form linear combination of modified silicate and powerlaw.</span>
    <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">ext</span> <span class="o">+</span> <span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="mf">9.7</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mf">1.7</span>
    <span class="n">si_em</span><span class="o">=</span><span class="n">amplitude</span><span class="o">*</span><span class="mf">1.0E-6</span><span class="o">*</span><span class="mf">3.97289E13</span><span class="o">/</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="mf">1.4387752E4</span><span class="o">/</span><span class="n">x</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">ext</span>
    
    <span class="k">return</span> <span class="n">si_em</span>

<span class="c1"># Enable tabulated extinction functions. Existing options in dust_extinction are insufficient</span>
<span class="c1"># at mid-IR wavelengths</span>

<span class="k">def</span> <span class="nf">extinction_a</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extinction from table data&quot;&quot;&quot;</span>
    <span class="n">ext</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>      
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau</span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>

<span class="c1">#Read extinction data from Chiar &amp; Tielens (2005)</span>
<span class="c1">#Note, this is normalized to extinction in the K-band (1.004 at 2.14 um)</span>
<span class="c1">#agal is for Galactic Center, alocal is for local ISM extinction</span>

<span class="n">Boxdata</span><span class="o">=</span><span class="s2">&quot;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/cube_fitting/&quot;</span>
<span class="n">wave</span><span class="p">,</span> <span class="n">agal</span><span class="p">,</span> <span class="n">alocal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">Boxdata</span><span class="o">+</span><span class="s1">&#39;chiar+tielens_2005.dat&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Compare to dust_extinction</span>
<span class="c1">#P92 is the only model that extends over the mid-IR range, but it is crude</span>
<span class="c1">#Normalized to extinction in the V-band</span>

<span class="kn">from</span> <span class="nn">dust_extinction.parameter_averages</span> <span class="kn">import</span> <span class="n">F99</span>
<span class="kn">from</span> <span class="nn">dust_extinction.shapes</span> <span class="kn">import</span> <span class="n">P92</span>
<span class="n">a92</span> <span class="o">=</span> <span class="n">P92</span><span class="p">()</span>

<span class="c1">#Extinction Comparison</span>
<span class="n">tau</span><span class="o">=</span><span class="mf">1.</span>
<span class="n">xa</span><span class="o">=</span><span class="n">arange</span><span class="p">(</span><span class="mf">5.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">extin1</span><span class="o">=</span><span class="n">extinction_a</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">alocal</span><span class="p">)</span>
<span class="n">extin2</span><span class="o">=</span><span class="n">extinction_a</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">agal</span><span class="p">)</span>
<span class="n">lam</span><span class="o">=</span><span class="n">xa</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span>
<span class="n">scale</span><span class="o">=</span><span class="mf">21.9</span>             <span class="c1">#Empirical scaling to adjust P2 curve to match Chiar &amp; Tielens Local ISM curve</span>
<span class="n">aa92</span><span class="o">=</span><span class="n">scale</span><span class="o">*</span><span class="n">a92</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
<span class="n">extin3</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau</span><span class="o">*</span><span class="n">aa92</span><span class="p">)</span>

<span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;CT+05 Local ISM&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;CT+05 Gal. Cen.&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;P92 scaled&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">pl1</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cube_fitting_9_0.png" src="../../_images/cube_fitting_9_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="model-parameters">
<h2>Model Parameters<a class="headerlink" href="#model-parameters" title="Permalink to this headline">¶</a></h2>
<p>Declare the parameters of model functions. Parameters are frozen by setting vary=’False’
in the lmfit setpar command.  For now we are just fitting amplitudes of emission features.
Fits with more variable parameters take longer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">vary</span><span class="p">,</span> <span class="n">minus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set any parameter&quot;&quot;&quot;</span>
    <span class="n">pars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">vary</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="n">minus</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">gaussian_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;set the parameters for a gaussian&quot;&quot;&quot;</span>
    <span class="n">std</span><span class="o">=</span><span class="n">stddev</span>
    <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">xcen</span><span class="o">=</span><span class="n">mean</span><span class="o">*</span><span class="n">OneZ</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_std&#39;</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1">#setpar(pars,name+&#39;_std&#39;,std,True,0)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_xcen&#39;</span><span class="p">,</span><span class="n">xcen</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude&#39;</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="c1">#pars[name+&#39;_std&#39;].set(std,vary=False),pars[name+&#39;_xcen&#39;].set(xcen,vary=False),pars[name+&#39;_amplitude&#39;].set(amplitude)</span>

<span class="k">def</span> <span class="nf">drude_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;set the parameters for a drude&quot;&quot;&quot;</span>
    <span class="n">peakx</span><span class="o">=</span><span class="n">peakx</span><span class="o">*</span><span class="n">OneZ</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_frac_FWHM&#39;</span><span class="p">,</span><span class="n">frac_FWHM</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1">#setpar(pars,name+&#39;_frac_FWHM&#39;,frac_FWHM,True,0)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_peakx&#39;</span><span class="p">,</span><span class="n">peakx</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude&#39;</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>    
    <span class="k">return</span> <span class="c1">#pars[name+&#39;_frac_FWHM&#39;].set(frac_FWHM,vary=False),pars[name+&#39;_peakx&#39;].set(peakx,vary=False),pars[name+&#39;_amplitude&#39;].set(amplitude)</span>

<span class="k">def</span> <span class="nf">pahdust_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">amplitude_76</span><span class="p">,</span> <span class="n">amplitude_113</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;set the parameters for pdr dust&quot;&quot;&quot;</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude_76&#39;</span><span class="p">,</span><span class="n">amplitude_76</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude_113&#39;</span><span class="p">,</span><span class="n">amplitude_113</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_OnePlusZ&#39;</span><span class="p">,</span><span class="n">OnePlusZ</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="c1">#pars[name+&#39;_frac_FWHM&#39;].set(frac_FWHM,vary=False),pars[name+&#39;_peakx&#39;].set(peakx,vary=False),pars[name+&#39;_amplitude&#39;].set(amplitude)</span>

<span class="k">def</span> <span class="nf">sidust_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_amplitude&#39;</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_T&#39;</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">gaussian_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract the parameters for a gaussian&quot;&quot;&quot;</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">cen</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;xcen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">amp</span><span class="p">,</span> <span class="n">cen</span><span class="p">,</span> <span class="n">std</span>

<span class="k">def</span> <span class="nf">drude_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract the parameters for a drude&quot;&quot;&quot;</span>
    <span class="n">ampl</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;peakx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>         
    <span class="n">frac</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;frac_FWHM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">ampl</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">frac</span>

<span class="k">def</span> <span class="nf">pahdust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract the parameters for pahdust model&quot;&quot;&quot;</span>
    <span class="n">ampl_76</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude_76&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ampl_113</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude_113&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">ampl_76</span><span class="p">,</span> <span class="n">ampl_113</span>  

<span class="k">def</span> <span class="nf">sidust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract the parameters for pahdust model&quot;&quot;&quot;</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ampl</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">T</span><span class="p">,</span><span class="n">ampl</span> 
</pre></div>
</div>
</div>
</div>
<div class="section" id="line-flux-from-model-parameters">
<h3>Line Flux from Model Parameters<a class="headerlink" href="#line-flux-from-model-parameters" title="Permalink to this headline">¶</a></h3>
<p>Helper functions to calculate the fluxes and widths of emission features from model parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#NOTE that these are ANALYTIC estimates of line fluxes,</span>
<span class="c1">#NOT available in astropy modeling or specutils</span>

<span class="k">def</span> <span class="nf">gaussianline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">cen</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calculate the integrated flux for a gaussian line&quot;&quot;&quot;</span>
    <span class="c1">#Units= amp:Jy cen:microns</span>
    <span class="n">c</span><span class="o">=</span> <span class="mf">29979.2458</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">10</span> <span class="c1">#c in microns/s</span>
    <span class="n">gaussianfactor</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">amp</span><span class="o">*</span><span class="n">gaussianfactor</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="n">std</span><span class="o">/</span><span class="p">(</span><span class="n">cen</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span>      <span class="c1">#erg s^{-1} cm^{-2}</span>

<span class="k">def</span> <span class="nf">drudeline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">frac</span><span class="p">,</span><span class="n">peak</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calculate the integrate flux for a drude line&quot;&quot;&quot;</span>
    <span class="c1">#Units= amp:Jy peak:microns</span>
    <span class="n">c</span><span class="o">=</span> <span class="mf">29979.2458</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">10</span> <span class="c1">#c in microns/s</span>
    <span class="n">drudefactor</span><span class="o">=</span><span class="n">pi</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">amp</span><span class="o">*</span><span class="n">frac</span><span class="o">*</span><span class="n">drudefactor</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">peak</span><span class="p">)))</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span>   <span class="c1">#erg s^{-1} cm^{-2}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="extract-and-plot-1d-spectrum-and-model-components">
<h3>Extract and plot 1D spectrum and model components<a class="headerlink" href="#extract-and-plot-1d-spectrum-and-model-components" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract spec and errors from a,b coordinates&quot;&quot;&quot;</span>
    <span class="n">spec_pix</span><span class="o">=</span><span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
    <span class="n">err_pix</span><span class="o">=</span><span class="n">error_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spec_pix</span><span class="p">,</span> <span class="n">err_pix</span>

<span class="k">def</span> <span class="nf">model_comps</span><span class="p">(</span><span class="n">model_result</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Evaluate model components&quot;&quot;&quot;</span>
    <span class="n">comps</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">eval_components</span><span class="p">()</span>
    <span class="n">plcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">h2comp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">pahcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sidustcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1">#print(comps.keys())</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">comps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
        <span class="n">keyl</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;pwl&#39;</span><span class="p">:</span> <span class="n">plcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">h2comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;pah&#39;</span><span class="p">:</span> <span class="n">pahcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;sid&#39;</span><span class="p">:</span> <span class="n">sidustcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
       
    <span class="n">plaw_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">h2_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">ion_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">pah_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">sidust_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">plcomp</span><span class="p">:</span> <span class="n">plaw_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">h2comp</span><span class="p">:</span> <span class="n">h2_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">pahcomp</span><span class="p">:</span> <span class="n">pah_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">sidustcomp</span><span class="p">:</span> <span class="n">sidust_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ArII&#39;</span><span class="p">,</span><span class="s1">&#39;SIV&#39;</span><span class="p">,</span><span class="s1">&#39;NeII&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
        <span class="n">ion_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="p">]</span>
        
    <span class="k">return</span><span class="p">([</span><span class="n">plaw_model</span><span class="p">,</span><span class="n">h2_model</span><span class="p">,</span><span class="n">ion_model</span><span class="p">,</span><span class="n">pah_model</span><span class="p">,</span><span class="n">sidust_model</span><span class="p">],[</span><span class="s1">&#39;PL&#39;</span><span class="p">,</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span><span class="s1">&#39;Ions&#39;</span><span class="p">,</span><span class="s1">&#39;PAHs&#39;</span><span class="p">,</span><span class="s1">&#39;Si Dust&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">model_result</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;plot spectrum, model components, and residual&quot;&quot;&quot;</span>

    <span class="c1">#Model Results</span>
    <span class="n">fit_model</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">best_fit</span> 
    <span class="n">fit_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">fit_model</span>

    <span class="c1">#Evaluate model components</span>
    <span class="n">mod_comps</span><span class="p">,</span><span class="n">mod_labels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">model_result</span><span class="p">)</span>
        
    <span class="c1">#Spec-1D object</span>
    <span class="n">spec1</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">x</span><span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">spec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">specerr</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>    
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  
        <span class="c1">#ax.step, ax.plot, ax.scatter all work, but ax.scatter doesn&#39;t autscale correctly</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="c1">#ax.set_xlabel(r&quot;$Wavelength\ (\mu m)$&quot;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="c1">#plt.errorbar only works on unitless data</span>
        <span class="c1">#ax.errorbar(spec1.spectral_axis, spec1.flux, yerr=specerr,label=&#39;Data&#39;, color=&#39;k&#39;)</span>
        <span class="c1">#ax.plot(spec1.spectral_axis, spec1.flux, yerr=specerr,label=&#39;Data&#39;, color=&#39;k&#39;)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>   

    <span class="c1">#Plot results</span>
    <span class="n">fig1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span> <span class="mi">150</span><span class="p">)</span>
    
    <span class="n">frame1</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.3</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.6</span><span class="p">))</span>
    <span class="n">frame1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Flux\ (Jy)$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">specerr</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit_model</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">mod_colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="s1">&#39;orange&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">mlabel</span><span class="p">,</span> <span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mod_comps</span><span class="p">,</span><span class="n">mod_labels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">mlabel</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>        
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">frame2</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.2</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Wavelength\ (\mu m)$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fit_residual</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">specerr</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>     
    <span class="k">return</span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="input-data">
<h2>Input data<a class="headerlink" href="#input-data" title="Permalink to this headline">¶</a></h2>
<p>With the present lack of JWST flight data, we utilize the SL1 and SL2 spectral cubes generated
using CUBISM, from Spitzer IRS spectral mapping observations of the center of nearby
galaxy Messier 58. This galaxy has a radio-loud Seyfert nucleus that is exciting strong
H2 emission via shocks.  There is also significant star-formation, revealed by PAH emission
features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Spitzer IRS (CUBISM) cube loader does not exist in specutils</span>

<span class="c1">#Target </span>
<span class="n">targname</span><span class="o">=</span><span class="s1">&#39;M58&#39;</span>

<span class="c1">#Redshift</span>
<span class="n">z</span><span class="o">=</span><span class="mf">0.005060</span>
<span class="n">OneZ</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span>

<span class="c1">#Download and open the data cubes and their uncertainties</span>
<span class="n">BoxPath</span><span class="o">=</span><span class="s2">&quot;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/cube_fitting/&quot;</span>
<span class="n">cubeSL1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">&#39;_SL1_cube.fits&#39;</span><span class="p">)</span> 
<span class="n">errorsSL1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">&#39;_SL1_cube_unc.fits&#39;</span><span class="p">)</span>
<span class="n">cubeSL2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">&#39;_SL2_cube.fits&#39;</span><span class="p">)</span> 
<span class="n">errorsSL2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">&#39;_SL2_cube_unc.fits&#39;</span><span class="p">)</span>

<span class="c1">#Cube Info and Headers</span>
<span class="n">cubeSL1</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">cubeSL2</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">hdr1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>                        
<span class="n">er_hdr1</span><span class="o">=</span><span class="n">errorsSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">hdr2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>                               
<span class="n">er_hdr2</span><span class="o">=</span><span class="n">errorsSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="c1">#print(repr(hdr1))</span>

<span class="c1">#Flux Data</span>
<span class="n">data_cube1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">error_cube1</span> <span class="o">=</span> <span class="n">errorsSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">data_cube2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">error_cube2</span> <span class="o">=</span> <span class="n">errorsSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1">#Wavelength Data</span>
<span class="n">xwave1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">xwave1</span> <span class="o">=</span> <span class="n">xwave1</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xwave2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">xwave2</span> <span class="o">=</span> <span class="n">xwave2</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xwave2</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xwave1</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1">#Change the units from MJy/sr to Jy/pix</span>
<span class="n">correct_unit1</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">0.0003046118</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>    
<span class="n">data_cube1</span><span class="o">=</span><span class="n">data_cube1</span><span class="o">*</span><span class="n">correct_unit1</span>
<span class="n">error_cube1</span><span class="o">=</span><span class="n">error_cube1</span><span class="o">*</span><span class="n">correct_unit1</span>
<span class="n">correct_unit2</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr2</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr2</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">0.0003046118</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>    
<span class="n">data_cube2</span><span class="o">=</span><span class="n">data_cube2</span><span class="o">*</span><span class="n">correct_unit2</span>
<span class="n">error_cube2</span><span class="o">=</span><span class="n">error_cube2</span><span class="o">*</span><span class="n">correct_unit2</span>

<span class="c1">#Concatenate SL1 and SL2</span>
<span class="n">data_cube</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_cube2</span><span class="p">,</span><span class="n">data_cube1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">error_cube</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">error_cube2</span><span class="p">,</span><span class="n">error_cube1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Reorder x and data_cube</span>
<span class="n">xcor</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
<span class="n">data_cube</span> <span class="o">=</span> <span class="n">data_cube</span><span class="p">[</span><span class="n">xcor</span><span class="p">]</span>
<span class="n">error_cube</span> <span class="o">=</span> <span class="n">error_cube</span><span class="p">[</span><span class="n">xcor</span><span class="p">]</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1">#Cube dimensions and trimming </span>
<span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>
<span class="n">ytrim</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ysize</span><span class="o">=</span><span class="n">ysize</span><span class="o">-</span><span class="n">ytrim</span>
<span class="n">ztrim</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">zsize</span><span class="o">=</span><span class="n">zsize</span><span class="o">-</span><span class="n">ztrim</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trimmed cube dimensions:&#39;</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">)</span>

<span class="c1">#Collapsed 2D image</span>
<span class="n">cube_2dflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">ysize</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">zsize</span><span class="p">]</span>

<span class="c1">#Collapsed 1D spectrum</span>
<span class="n">cube_1dflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ysize</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zsize</span><span class="p">):</span>
        <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="n">cube_1dflux</span><span class="o">=</span><span class="n">cube_1dflux</span><span class="o">+</span><span class="n">spec_pix</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log Flux (Sum over Wavelength)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_2dflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flux (Sum over Spaxels)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">cube_1dflux</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filename: /home/runner/.astropy/cache/download/url/06853bf85036af1a6d55c1fb3a08260f/contents
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     286   (35, 30, 117)   float32   
  1  WCS-TAB       1 BinTableHDU     13   1R x 1C   [117E]   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Filename: /home/runner/.astropy/cache/download/url/bec801dcb9ee22f478e4a56b91820bd4/contents
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     286   (35, 30, 77)   float32   
  1  WCS-TAB       1 BinTableHDU     13   1R x 1C   [77E]   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trimmed cube dimensions: 194 30 32
</pre></div>
</div>
<img alt="../../_images/cube_fitting_17_3.png" src="../../_images/cube_fitting_17_3.png" />
</div>
</div>
</div>
<div class="section" id="model-parameter-starting-values">
<h2>Model Parameter Starting Values<a class="headerlink" href="#model-parameter-starting-values" title="Permalink to this headline">¶</a></h2>
<p>Set starting parameters for spectral model components. Use a PAH dust model with only two free parameters (7.6 and 11.3 micron PAH flux).  The rest of the PAH ratios are fixed by this ‘pahdust’ model, so that fitting the whole cube does not take so long.   Later, we will fit summed region spectra with all PAH amplitudes free.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Power Law</span>
<span class="n">p_law</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">powerlaw</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;pwl_&#39;</span><span class="p">)</span>
<span class="n">generic_pars</span> <span class="o">=</span> <span class="n">p_law</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>      
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.0002</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#PAH dust model with fixed PAH feature ratios</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;pahdust1_&#39;</span>
<span class="n">pahs</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">pahdust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pahs</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">pahdust_defpar</span><span class="p">(</span><span class="s1">&#39;pahdust1&#39;</span><span class="p">,</span><span class="mf">1.00506</span><span class="p">,</span><span class="mf">0.003</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Silicate dust emission</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sidust1_&#39;</span>
<span class="n">silicate</span><span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">sidust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">silicate</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">&#39;sidust1&#39;</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">1.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Gaussians with wavelengths from Smith et al 2007</span>
<span class="c1">#H2 pure-rotational lines</span>
<span class="n">h2lines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;55&#39;</span><span class="p">,</span><span class="s1">&#39;61&#39;</span><span class="p">,</span><span class="s1">&#39;69&#39;</span><span class="p">,</span><span class="s1">&#39;80&#39;</span><span class="p">,</span><span class="s1">&#39;96&#39;</span><span class="p">,</span><span class="s1">&#39;122&#39;</span><span class="p">]</span>
<span class="n">h2wavel</span><span class="o">=</span><span class="p">[</span><span class="mf">5.511</span><span class="p">,</span><span class="mf">6.109</span><span class="p">,</span><span class="mf">6.909</span><span class="p">,</span><span class="mf">8.026</span><span class="p">,</span><span class="mf">9.665</span><span class="p">,</span><span class="mf">12.278</span><span class="p">]</span>
<span class="n">amp_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">std_guess</span><span class="o">=</span><span class="mf">0.04</span>
<span class="n">gaussH2</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">h2lines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="n">gaussH2</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussH2</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="k">for</span> <span class="n">h2lin</span><span class="p">,</span> <span class="n">h2w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h2lines</span><span class="p">,</span><span class="n">h2wavel</span><span class="p">):</span>
    <span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="o">+</span><span class="n">h2lin</span><span class="p">,</span> <span class="n">amp_guess</span><span class="p">,</span> <span class="n">h2w</span><span class="p">,</span> <span class="n">std_guess</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Atomic lines</span>
<span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ArII&#39;</span><span class="p">,</span><span class="s1">&#39;SIV&#39;</span><span class="p">,</span><span class="s1">&#39;NeII&#39;</span><span class="p">]</span>
<span class="n">atomicwavel</span><span class="o">=</span><span class="p">[</span><span class="mf">6.985</span><span class="p">,</span><span class="mf">10.511</span><span class="p">,</span><span class="mf">12.813</span><span class="p">]</span>
<span class="n">amp_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">std_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">gaussAt</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="n">gaussAt</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussAt</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="k">for</span> <span class="n">atlin</span><span class="p">,</span> <span class="n">atw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atomiclines</span><span class="p">,</span><span class="n">atomicwavel</span><span class="p">):</span>
    <span class="n">gaussian_defpar</span><span class="p">(</span><span class="n">atlin</span><span class="p">,</span><span class="n">amp_guess</span><span class="p">,</span> <span class="n">atw</span><span class="p">,</span> <span class="n">std_guess</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fit-a-representative-spaxel">
<h2>Fit a Representative Spaxel<a class="headerlink" href="#fit-a-representative-spaxel" title="Permalink to this headline">¶</a></h2>
<p>Fit a single spaxel in the cube and use the fit parameters to adjust the generic model starting parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Select spaxel</span>
<span class="n">spec</span><span class="o">=</span><span class="n">data_cube</span><span class="p">[:,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">error_cube</span><span class="p">[:,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span>

<span class="c1">#Composite model (powerlaw + PAHs + H2 + Atomic lines, no extinction)</span>
<span class="n">generic_mod</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">silicate</span> <span class="o">+</span> <span class="n">pahs</span> <span class="o">+</span> <span class="n">gaussH2</span>  <span class="o">+</span> <span class="n">gaussAt</span>

<span class="nb">print</span><span class="p">(</span><span class="n">generic_mod</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>

<span class="c1">#Fit and plot</span>
<span class="n">spax_result</span> <span class="o">=</span> <span class="n">generic_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">spax_result</span><span class="p">)</span>

<span class="c1">#Save results</span>
<span class="n">save_modelresult</span><span class="p">(</span><span class="n">spax_result</span><span class="p">,</span> <span class="s1">&#39;OnePointResult.sav&#39;</span><span class="p">)</span>

<span class="c1">#Update generic model starting parameters</span>
<span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
    <span class="n">value</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">vary</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span>
    <span class="n">minus</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">min</span>
    <span class="k">if</span> <span class="n">minus</span><span class="o">==</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">):</span>
        <span class="n">minus</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">generic_pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">vary</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="n">minus</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;pwl_c1&#39;, &#39;pwl_c2&#39;, &#39;sidust1_T&#39;, &#39;sidust1_amplitude&#39;, &#39;pahdust1_OnePlusZ&#39;, &#39;pahdust1_amplitude_76&#39;, &#39;pahdust1_amplitude_113&#39;, &#39;h55_amplitude&#39;, &#39;h55_xcen&#39;, &#39;h55_std&#39;, &#39;h61_amplitude&#39;, &#39;h61_xcen&#39;, &#39;h61_std&#39;, &#39;h69_amplitude&#39;, &#39;h69_xcen&#39;, &#39;h69_std&#39;, &#39;h80_amplitude&#39;, &#39;h80_xcen&#39;, &#39;h80_std&#39;, &#39;h96_amplitude&#39;, &#39;h96_xcen&#39;, &#39;h96_std&#39;, &#39;h122_amplitude&#39;, &#39;h122_xcen&#39;, &#39;h122_std&#39;, &#39;ArII_amplitude&#39;, &#39;ArII_xcen&#39;, &#39;ArII_std&#39;, &#39;SIV_amplitude&#39;, &#39;SIV_xcen&#39;, &#39;SIV_std&#39;, &#39;NeII_amplitude&#39;, &#39;NeII_xcen&#39;, &#39;NeII_std&#39;]
</pre></div>
</div>
<img alt="../../_images/cube_fitting_21_1.png" src="../../_images/cube_fitting_21_1.png" />
<img alt="../../_images/cube_fitting_21_2.png" src="../../_images/cube_fitting_21_2.png" />
</div>
</div>
<p>Plot of observed flux density (black), model fit (red), and residuals (bottom panel).  This spaxel has strong H2 emission at 9.6 microns and 8 micron PAH and [Ne II] 12.8 micron emission from star-forming regions.</p>
</div>
<div class="section" id="fit-the-entire-cube">
<h2>Fit the Entire Cube<a class="headerlink" href="#fit-the-entire-cube" title="Permalink to this headline">¶</a></h2>
<p>Identify NaNs, then create list of models (based on generic model), one entry per NaN-free spaxel. Next launch the multiprocessing Pool, limited to number of available cores minus one. Fitting the entire cube (900 spaxels) takes about 2 minutes to fit with 7 processes running in parallel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cube_res</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

<span class="c1">#The fit method is redefined as a top-level function to make it pickle-able for multiprocessing.Pool</span>
<span class="k">def</span> <span class="nf">modfit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">modf</span><span class="o">=</span><span class="n">generic_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">spaxerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">modf</span><span class="o">.</span><span class="n">dumps</span><span class="p">()</span>

<span class="c1">#Helper to either assign a NaN result or fit a single non-NaN spaxel</span>
<span class="k">def</span> <span class="nf">fit_point</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">spaxel</span><span class="p">,</span><span class="n">spaxerr</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">,</span><span class="n">nancheck</span> <span class="o">=</span> <span class="n">args</span>
        <span class="c1"># print(a, b, len(spaxel), mp.current_process().name)</span>
        <span class="k">if</span> <span class="n">nancheck</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">res_point</span><span class="o">=</span><span class="n">modfit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">spaxerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

            <span class="n">cube_res</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res_point</span> 
        <span class="k">elif</span> <span class="n">nancheck</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cube_res</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">return</span> 

<span class="c1">#Extraction region dimensions (trimmed cube)</span>
<span class="n">astart</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">aend</span><span class="o">=</span><span class="n">ysize</span>
<span class="n">bstart</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">bend</span><span class="o">=</span><span class="n">zsize</span>

<span class="c1">#Check for NaNs, select data, and set model start parameters for each spaxel</span>
<span class="n">pooldata</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">astart</span><span class="p">,</span><span class="n">aend</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bstart</span><span class="p">,</span><span class="n">bend</span><span class="p">):</span>        
        <span class="n">nancheck</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">point</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nancheck</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1">#Copy spaxel data vectors</span>
        <span class="n">spaxel</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
        <span class="n">spaxerr</span><span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">error_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
        <span class="n">wavelen</span><span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="n">pooldata</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">spaxel</span><span class="p">,</span><span class="n">spaxerr</span><span class="p">,</span><span class="n">wavelen</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">,</span><span class="n">nancheck</span><span class="p">])</span>


<span class="c1">#Launch Multiprocessing Pool</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fit_point</span><span class="p">,</span><span class="n">pooldata</span><span class="p">)</span>    

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time count&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="c1">#Save model fit</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;MPF_cube_result_model.sav&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">fp</span><span class="p">)</span>

<span class="c1">#Load model fit to full cube</span>
<span class="n">cube_res</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="s1">&#39;MPF_cube_result_model.sav&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">restore_cube</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">restore_cube</span><span class="p">:</span>
    <span class="n">pos</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Process ForkPoolWorker-2:
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">Input In [10],</span> in <span class="ni">&lt;cell line: 43&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span>     <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">45</span>         <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fit_point</span><span class="p">,</span><span class="n">pooldata</span><span class="p">)</span>    
<span class="g g-Whitespace">     </span><span class="mi">47</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time count&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/multiprocessing/pool.py:364,</span> in <span class="ni">Pool.map</span><span class="nt">(self, func, iterable, chunksize)</span>
<span class="g g-Whitespace">    </span><span class="mi">359</span> <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">360</span>     <span class="sd">&#39;&#39;&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">361</span><span class="sd">     Apply `func` to each element in `iterable`, collecting the results</span>
<span class="g g-Whitespace">    </span><span class="mi">362</span><span class="sd">     in a list that is returned.</span>
<span class="g g-Whitespace">    </span><span class="mi">363</span><span class="sd">     &#39;&#39;&#39;</span>
<span class="ne">--&gt; </span><span class="mi">364</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">mapstar</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/multiprocessing/pool.py:765,</span> in <span class="ni">ApplyResult.get</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">764</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">765</span>     <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">766</span>     <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">767</span>         <span class="k">raise</span> <span class="ne">TimeoutError</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/multiprocessing/pool.py:762,</span> in <span class="ni">ApplyResult.wait</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">761</span> <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">762</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/threading.py:574,</span> in <span class="ni">Event.wait</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">572</span> <span class="n">signaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">signaled</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">574</span>     <span class="n">signaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">575</span> <span class="k">return</span> <span class="n">signaled</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/threading.py:312,</span> in <span class="ni">Condition.wait</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> <span class="k">try</span><span class="p">:</span>    <span class="c1"># restore state no matter what (e.g., KeyboardInterrupt)</span>
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">312</span>         <span class="n">waiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>         <span class="n">gotit</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>     <span class="k">else</span><span class="p">:</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="section" id="total-flux-and-reduced-chi-2-maps">
<h3>Total flux and Reduced Chi^2 Maps<a class="headerlink" href="#total-flux-and-reduced-chi-2-maps" title="Permalink to this headline">¶</a></h3>
<p>Display total flux image (observed flux cube collapsed along wavelength direction) and reduced Chi^2 image for model fit in square sub-region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Sum observed flux in each spaxel</span>
<span class="n">cube_tflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">ysize</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">zsize</span><span class="p">]</span>

<span class="c1">#Sum model flux in each spaxel</span>
<span class="n">tcube_chi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">))</span>
<span class="n">tcube_modflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">))</span>
<span class="n">funcdefs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">modres</span><span class="o">=</span><span class="n">spax_result</span>
<span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1">#for pos, dumpval in cube_res:</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>
        <span class="n">tcube_modflux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="n">tcube_chi</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
        <span class="n">tcube_modflux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">)</span>
        <span class="n">tcube_chi</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">redchi</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log Observed Flux&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_tflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;log Model Flux&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tcube_modflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reduced Chi Square&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_tflux</span><span class="o">-</span><span class="n">tcube_modflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Collapsed cube maps, showing observed flux, model flux, and Chi^2/DF.  White regions with NaNs in the input data cube also have NaNs in the output model cube along the left and top edges and in column 26.  Residuals in the nucleus may either be the result of inadequate PSF sampling or mis-fit AGN model.</p>
</div>
<div class="section" id="line-and-pah-feature-flux-maps">
<h3>Line and PAH feature flux maps.<a class="headerlink" href="#line-and-pah-feature-flux-maps" title="Permalink to this headline">¶</a></h3>
<div class="section" id="functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
<h4>Functions to extract line and PAH maps from model parameter cube<a class="headerlink" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">line_map</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create total emission line flux map for Gaussian emission line model component&quot;&quot;&quot;</span>
    
    <span class="n">line_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>
            <span class="n">line_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
            <span class="n">amp</span><span class="p">,</span> <span class="n">cen</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gaussian_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>               
            <span class="n">line_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">gaussianline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">cen</span><span class="p">)</span>                      

    <span class="k">return</span> <span class="n">line_flux</span>

<span class="k">def</span> <span class="nf">pahdust_maps</span><span class="p">(</span><span class="n">pahdust_comp</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create total emission line flux map for Gaussian emission line model component&quot;&quot;&quot;</span>
    
    <span class="n">pah_ion_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="n">pah_neutral_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>
            <span class="n">pah_ion_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
            <span class="n">pah_neutral_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">pahdust_comp</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
            <span class="n">ampl_76</span><span class="p">,</span> <span class="n">ampl_113</span> <span class="o">=</span> <span class="n">pahdust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>  
            <span class="n">pah_76_flux</span> <span class="o">=</span> <span class="n">drudeline_flux</span><span class="p">(</span><span class="n">ampl_76</span><span class="p">,</span><span class="mf">0.044</span><span class="p">,</span><span class="mf">7.60</span><span class="p">)</span>
            <span class="n">pah_113_flux</span> <span class="o">=</span> <span class="n">drudeline_flux</span><span class="p">(</span><span class="n">ampl_113</span><span class="p">,</span><span class="mf">0.032</span><span class="p">,</span><span class="mf">11.33</span><span class="p">)</span>                      
            <span class="n">pah_ion_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">pah_76_flux</span>
            <span class="n">pah_neutral_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">pah_113_flux</span>

    <span class="k">return</span> <span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span>

<span class="k">def</span> <span class="nf">sidust_map</span><span class="p">(</span><span class="n">sidust_comp</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create silicate dust emission map&quot;&quot;&quot;</span>
    <span class="n">sidust_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;nan&#39;</span><span class="p">:</span>
            <span class="n">sidust_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">sidust_comp</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
            <span class="n">t</span><span class="p">,</span><span class="n">si_ampl</span> <span class="o">=</span> <span class="n">sidust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
            <span class="n">si_norm</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="n">sidust_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">si_ampl</span><span class="o">*</span><span class="n">si_norm</span>
            
    <span class="k">return</span> <span class="n">sidust_flux</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
<h4>H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model<a class="headerlink" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h2_flux</span><span class="o">=</span><span class="n">line_map</span><span class="p">(</span><span class="s1">&#39;h96&#39;</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">ne_flux</span><span class="o">=</span><span class="n">line_map</span><span class="p">(</span><span class="s1">&#39;NeII&#39;</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span> <span class="o">=</span> <span class="n">pahdust_maps</span><span class="p">(</span><span class="s1">&#39;pahdust1&#39;</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">sidust_flux</span><span class="o">=</span><span class="n">sidust_map</span><span class="p">(</span><span class="s1">&#39;sidust1&#39;</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;[Ne II] 12.8 um&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ne_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2 9.6 um&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PAH 7.6 um&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PAH 11.3 um&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Si dust em.&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sidust_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>           
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">#Make RGB images</span>
<span class="n">stretch1</span><span class="o">=</span><span class="mf">0.000000000000004</span>
<span class="n">stretch2</span><span class="o">=</span><span class="mf">0.000000000000005</span>
<span class="n">m58_neii_pah0_h2</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="n">ne_flux</span><span class="p">,</span> <span class="n">h2_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">stretch1</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;m58_NeII_H96_PAH113.png&quot;</span><span class="p">)</span>
<span class="n">m58_pah_h2</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">h2_flux</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">stretch2</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;m58_PAH113_H96_PAH76.png&quot;</span><span class="p">)</span>

<span class="c1">#Two-panel figure</span>
<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_neii_pah0_h2</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_pah_h2</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>3-color RGB images. Top: individual feature maps. Bottom left: r = [Ne II] 12.8 micron, g = H2 S(3) 9.6 micron, b = PAH 11.3 micron. Ionized atomic gas in the active galactic nucleus shows up as red, shocked regions are green, and dust emission is blue. Bottom right: r = PAH 11.3 micron, g = H2 S(3) 9.6 micron, b = PAH 7.6 micron. Neutral PAH emission shows up as red, ionized PAH emission from PDRs in star-forming regions is blue, and shocked regions are green.</p>
</div>
</div>
</div>
<div class="section" id="extract-and-model-cube-sub-regions">
<h2>Extract and model cube sub-regions<a class="headerlink" href="#extract-and-model-cube-sub-regions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="make-spectral-region-masks">
<h3>Make spectral region masks<a class="headerlink" href="#make-spectral-region-masks" title="Permalink to this headline">¶</a></h3>
<p>Define spectral extraction regions based on spatial location, line flux, and line or feature ratios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Nucleus extraction region, defined by 5x5 square</span>
<span class="n">nuc_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">nuc_mask</span><span class="p">[</span><span class="mi">14</span><span class="o">-</span><span class="n">a</span><span class="p">,</span><span class="mi">17</span><span class="o">-</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#Spiral arm extraction region</span>
<span class="n">arm_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">pah_neutral_flux</span><span class="o">&gt;=</span><span class="mf">0.155e-14</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">pah_ion_flux</span><span class="o">/</span><span class="n">pah_neutral_flux</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Inner disk extraction region        </span>
<span class="n">pah_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">pah_neutral_flux</span><span class="o">&gt;=</span><span class="mf">0.155e-14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">h2_flux</span><span class="o">&lt;</span><span class="mf">1e-15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">arm_mask</span>
<span class="n">pah_mask</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#Trim edges of cube</span>
<span class="n">pah_mask</span><span class="p">[</span><span class="mi">28</span><span class="p">:,:]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Regions of strongest H2 emission</span>
<span class="n">h2s_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">h2_flux</span><span class="o">&gt;=</span><span class="mf">1e-15</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">h2_flux</span><span class="o">/</span><span class="n">pah_neutral_flux</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#H2 extraction region</span>
<span class="n">h2_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">h2_flux</span><span class="o">&gt;=</span><span class="mf">1e-15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">h2s_mask</span>

<span class="c1">#M58 combined central regions mask (excluding spiral arm)</span>
<span class="n">m58_mask</span><span class="o">=</span><span class="n">nuc_mask</span> <span class="o">+</span> <span class="n">h2_mask</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">h2s_mask</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">pah_mask</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span><span class="n">arm_mask</span><span class="o">*</span><span class="mi">5</span>

<span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Nucleus&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nuc_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spiral Arm&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arm_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Inner Disk&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2-strongest&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2s_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All regions&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Extraction region masks based on spatial and emission line or PAH feature strengths.</p>
</div>
<div class="section" id="extract-spectra-from-mask-regions">
<h3>Extract spectra from mask regions<a class="headerlink" href="#extract-spectra-from-mask-regions" title="Permalink to this headline">¶</a></h3>
<p>Spectra summed over five different regions: Spiral Arm, Nucleus, PAH, H2, and Strongest H2</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuc_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">nuc_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">pah_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">pah_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">arm_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">arm_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2s_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2s_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ysize</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zsize</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nuc_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">nuc_spec</span><span class="o">=</span><span class="n">nuc_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">nuc_err</span><span class="o">=</span><span class="n">nuc_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">pah_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">pah_spec</span><span class="o">=</span><span class="n">pah_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">pah_err</span><span class="o">=</span><span class="n">pah_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">h2_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">h2_spec</span><span class="o">=</span><span class="n">h2_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">h2_err</span><span class="o">=</span><span class="n">h2_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">arm_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">arm_spec</span><span class="o">=</span><span class="n">arm_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">arm_err</span><span class="o">=</span><span class="n">arm_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">h2s_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">h2s_spec</span><span class="o">=</span><span class="n">h2s_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">h2s_err</span><span class="o">=</span><span class="n">h2s_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>

<span class="n">nuc_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nuc_err</span><span class="p">)</span>
<span class="n">pah_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pah_err</span><span class="p">)</span>
<span class="n">h2_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h2_err</span><span class="p">)</span>
<span class="n">arm_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arm_err</span><span class="p">)</span>
<span class="n">h2s_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h2s_err</span><span class="p">)</span>
<span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">),(</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spiral Arm&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">arm_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">arm_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Nucleus&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nuc_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">nuc_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Inner Disk&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pah_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">pah_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All regions&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel&#39;</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2-Strongest&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2s_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2s_err</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="save-spectra-to-files">
<h3>Save spectra to files<a class="headerlink" href="#save-spectra-to-files" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#np.savetxt(targname+&#39;_spec_nuc.dat&#39;, np.column_stack((x, nuc_spec, nuc_err)),header=&#39;Wavelength[microns]     Flux_Nucleus[Jy]      Err_Flux_Nucleus&#39;)</span>
<span class="c1">#np.savetxt(targname+&#39;_spec_h2.dat&#39;, np.column_stack((x, h2_spec, h2_err)), header=&#39;Wavelength[microns]     Flux_H2[Jy]      Err_H2&#39;)</span>
<span class="c1">#np.savetxt(targname+&#39;_spec_h2s.dat&#39;, np.column_stack((x, h2_spec, h2_err)), header=&#39;Wavelength[microns]     Flux_H2s[Jy]      Err_H2s&#39;)</span>
<span class="c1">#np.savetxt(targname+&#39;_spec_pah.dat&#39;, np.column_stack((x, pah_spec, pah_err)), header=&#39;Wavelength[microns]     Flux_PAH[Jy]      Err_PAH&#39;)</span>
<span class="c1">#np.savetxt(targname+&#39;_spec_arm.dat&#39;, np.column_stack((x, arm_spec, arm_err)), header=&#39;Wavelength[microns]     Flux_Arm[Jy]      Err_Arm&#39;)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fit-spectra-of-regions">
<h3>Fit spectra of regions<a class="headerlink" href="#fit-spectra-of-regions" title="Permalink to this headline">¶</a></h3>
<div class="section" id="generic-model-components">
<h4>Generic model components<a class="headerlink" href="#generic-model-components" title="Permalink to this headline">¶</a></h4>
<p>Model 14 individual PAH components with all amplitudes free. It would be computationally expensive to do this
for the full cube, but only takes a couple of seconds for the summed region spectra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Power Law</span>
<span class="n">p_law</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">powerlaw</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;pwl_&#39;</span><span class="p">)</span>
<span class="n">generic_pars</span> <span class="o">=</span> <span class="n">p_law</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>      <span class="c1">#Generate the parameters</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Individual PAHs</span>
<span class="n">drudes</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="n">allpahlines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;52&#39;</span><span class="p">,</span><span class="s1">&#39;62&#39;</span><span class="p">,</span><span class="s1">&#39;74&#39;</span><span class="p">,</span><span class="s1">&#39;76&#39;</span><span class="p">,</span><span class="s1">&#39;78&#39;</span><span class="p">,</span><span class="s1">&#39;83&#39;</span><span class="p">,</span><span class="s1">&#39;86&#39;</span><span class="p">,</span><span class="s1">&#39;112&#39;</span><span class="p">,</span><span class="s1">&#39;113&#39;</span><span class="p">,</span><span class="s1">&#39;119&#39;</span><span class="p">,</span><span class="s1">&#39;126&#39;</span><span class="p">,</span><span class="s1">&#39;134&#39;</span><span class="p">,</span><span class="s1">&#39;140&#39;</span><span class="p">,</span><span class="s1">&#39;141&#39;</span><span class="p">]</span> 
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">allpahlines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;PAH&#39;</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>  
    <span class="n">drudes</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">drude</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>  
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">drudes</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>

<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH52&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">5.27</span><span class="p">,</span> <span class="mf">0.034</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH62&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.22</span><span class="p">,</span> <span class="mf">0.030</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH74&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">7.42</span><span class="p">,</span> <span class="mf">0.126</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH76&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">7.60</span><span class="p">,</span> <span class="mf">0.044</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH78&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">7.85</span><span class="p">,</span> <span class="mf">0.053</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH83&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">8.33</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH86&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">8.61</span><span class="p">,</span> <span class="mf">0.039</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH112&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.23</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH113&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.33</span><span class="p">,</span> <span class="mf">0.032</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH119&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.99</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH126&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">12.62</span><span class="p">,</span> <span class="mf">0.042</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH134&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">13.48</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH140&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">14.04</span><span class="p">,</span> <span class="mf">0.016</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">&#39;PAH141&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">14.19</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Silicate dust emission</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sidust1_&#39;</span>
<span class="n">silicate</span><span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">sidust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">silicate</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">&#39;sidust1&#39;</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">1.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Gaussians with FWHM and X central from Smith et al 2007</span>
<span class="c1">#H2 molecular</span>
<span class="n">h2lines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;55&#39;</span><span class="p">,</span><span class="s1">&#39;61&#39;</span><span class="p">,</span><span class="s1">&#39;69&#39;</span><span class="p">,</span><span class="s1">&#39;80&#39;</span><span class="p">,</span><span class="s1">&#39;96&#39;</span><span class="p">,</span><span class="s1">&#39;122&#39;</span><span class="p">]</span>
<span class="n">gaussH2</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">h2lines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="n">gaussH2</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussH2</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h55&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">5.511</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h61&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.109</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h69&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.909</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h80&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">8.026</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h96&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">9.665</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;h122&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">12.278</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Atomic lines</span>
<span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ArII&#39;</span><span class="p">,</span><span class="s1">&#39;SIV&#39;</span><span class="p">,</span><span class="s1">&#39;NeII&#39;</span><span class="p">]</span>
<span class="n">gaussAt</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
    <span class="n">gaussAt</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussAt</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;ArII&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.985</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;SIV&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">10.511</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">&#39;NeII&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">12.813</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="spiral-arm-spectral-fit">
<h4>Spiral arm spectral fit<a class="headerlink" href="#spiral-arm-spectral-fit" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Spiral arm spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">arm_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">arm_err</span>

<span class="c1">#Model (powerlaw + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussAt</span> <span class="o">+</span> <span class="n">gaussH2</span>

<span class="c1">#Adjust power law starting parameters </span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.001</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">arm_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">arm_model</span> <span class="o">=</span> <span class="n">arm_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">arm_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">arm_model</span>
<span class="n">arm_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">arm_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="c1">#plot_fit(x, spec, specerr, arm_result)</span>
</pre></div>
</div>
</div>
</div>
<p>Model fit to integrated spectrum of spiral arm region.</p>
</div>
<div class="section" id="h2-strongest-region-spectral-fit">
<h4>H2-strongest region spectral fit<a class="headerlink" href="#h2-strongest-region-spectral-fit" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#H2 region spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">h2s_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">h2s_err</span>

<span class="c1">#Model (powerlaw + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussAt</span> <span class="o">+</span> <span class="n">gaussH2</span>

<span class="c1">#Adjust power law starting parameters </span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.002</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">h2s_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">h2s_model</span> <span class="o">=</span> <span class="n">h2s_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">h2s_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">h2s_model</span>
<span class="n">h2s_modelcomps</span><span class="p">,</span><span class="n">h2s_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">h2s_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="c1">#plot_fit(x, spec, specerr, h2s_result)</span>
</pre></div>
</div>
</div>
</div>
<p>Model fit to integrated spectrum of H2-strongest region.</p>
</div>
<div class="section" id="nucleus-spectral-fit">
<h4>Nucleus spectral fit<a class="headerlink" href="#nucleus-spectral-fit" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Nucleus spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">nuc_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">nuc_err</span>

<span class="c1">#Model (powerlaw + AGN silicate emission + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">silicate</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussH2</span> <span class="o">+</span> <span class="n">gaussAt</span>

<span class="c1">#Adjust power law and silicate dust starting parameters</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c1&#39;</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">&#39;pwl_c2&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">&#39;sidust1&#39;</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">2.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">nuc_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">nuc_model</span> <span class="o">=</span> <span class="n">nuc_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">nuc_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">nuc_model</span>
<span class="n">nuc_modelcomps</span><span class="p">,</span><span class="n">nuc_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">nuc_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">nuc_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Model fit to nucleus, including fixed-temperature AGN silicate emission.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nuc_result</span>
<span class="c1">#result.fit_report(show_correl=False)</span>
</pre></div>
</div>
</div>
</div>
<p>Fit parameters for spectrum of nucleus</p>
</div>
</div>
</div>
<div class="section" id="summary-plot">
<h2>Summary Plot<a class="headerlink" href="#summary-plot" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">),(</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spiral Arm&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">arm_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">arm_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>
<span class="n">mod_colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="s1">&#39;orange&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arm_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Nucleus&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nuc_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">nuc_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
<span class="c1">#ax2.plot(x, fit_model,label=&#39;Model&#39;,c=&#39;red&#39;)</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nuc_modelcomps</span><span class="p">,</span><span class="n">nuc_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Inner Disk&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pah_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">pah_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;limegreen&#39;</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (Jy)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;All regions&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel&#39;</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;H2-Strongest&#39;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $(\mu m)$&quot;</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2s_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2s_err</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;teal&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h2s_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<img style="float: right;" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" alt="Space Telescope Logo" width="200px"/><p>Notebook created by Patrick Ogle and Ivan Lopez.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/cube_fitting"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By STScI<br/>
    
        &copy; Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>