
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Draft: Advanced Composite spectral model fitting &#8212; STScI JDAT Notebooks</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="MAST Query Tutorial for NIRSpec Users" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html" />
    <link rel="prev" title="Imaging Sky Background Estimation" href="../background_estimation_imaging/Imaging%20Sky%20Background%20Estimation.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/stsci_logo2.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">STScI JDAT Notebooks</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   James Webb Space Telescope Data Analysis Tool Notebooks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Cross-Instrument
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../asdf_example/asdf_example.html">
   Example of Converting a FITS File to ASDF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../background_estimation_imaging/Imaging%20Sky%20Background%20Estimation.html">
   Complex 2D Background
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Draft: Advanced Composite spectral model fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
   MAST Query
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
   Specviz Simple Demo
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MIRI
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
   MIRI MRS Spectroscopy of a Late M Star 1 - Running the Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
   Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
   JWST Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
   LRS Extraction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRCam
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
   Point Source Aperture Photometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRCam_photometry/NIRCam%20multiband%20photometry.html">
   NIRCam Multiband Photometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
   PSF Photometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
   NIRCam PSF-matched multiband photometry
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_02_calwebb.html">
   Preimaging - Calwebb
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preimaging/preimaging_03_association.html">
   Creating simulated images of the JWST astrometric calibration field in the LMC
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRISS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00.%20Optimal%20extraction.html">
   Part 0: Optimal Extraction of NIRISS WFSS Spectrum
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01.%20Combine%20and%20normalize%201D%20spectra.html">
   Part 1: Combine One-Dimensional NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02.%20Cross%20correlation%20template.html">
   Part 2: Cross Correlation to Determine Redshift of NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03.%20Spatially%20resolved%20emission%20line%20map.html">
   Part 3: Spatially Resolved Emission Line Map of NIRISS WFSS Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../niriss_ami_binary/1_niriss_ami_binary.html">
   NIRISS AMI simulation of binary point source AB Dor and calibrator HD37093
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../niriss_ami_binary/2_niriss_ami_binary.html">
   AMI Binary Star Notebook 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html">
   SOSS Transient Spectroscopy
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  NIRSpec
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
   IFU Optimal Extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../optimal_extraction_dynamic/Spectral%20Extraction.html">
   NIRSpec MOS Optimal Spectral Extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
   MOS Spectroscopy of Extragalactic Field
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
   Extracting an Exoplanet Transmission Spectrum from NIRSpec BOTS Time Series Observations
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/composite_model_fitting/specfit_demo_3.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/spacetelescope/jdat_notebooks/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/composite_model_fitting/specfit_demo_3.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Draft: Advanced Composite spectral model fitting
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     Introduction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#developer-notes">
       Developer Notes
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id1">
         Developer notes:
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-input">
     Data input
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#developer-note">
       Developer note
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#put-the-spectrum-into-a-spectrum1d-object">
     Put the spectrum into a Spectrum1D object
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-in-the-spectral-regions">
     Read in the spectral regions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-mask-from-the-regions">
     Create a mask from the regions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       Developer note
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convenience-routine-for-plotting-a-spectrum-and-highlighting-the-mask">
     Convenience routine for plotting a spectrum and highlighting the mask
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       Developer notes
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fitting">
   Fitting
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Developer notes
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Developer note
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#looking-at-the-fit-results">
   Looking at the fit results
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     Developer note
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     Developer note
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     Developer note
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#input-and-output-compound-models">
     Input and output compound models
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id12">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-residuals">
     Plot the residuals
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-individual-components">
     Plot individual components
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id13">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Draft: Advanced Composite spectral model fitting</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Draft: Advanced Composite spectral model fitting
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction">
     Introduction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#developer-notes">
       Developer Notes
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id1">
         Developer notes:
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-input">
     Data input
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#developer-note">
       Developer note
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#put-the-spectrum-into-a-spectrum1d-object">
     Put the spectrum into a Spectrum1D object
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#read-in-the-spectral-regions">
     Read in the spectral regions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-mask-from-the-regions">
     Create a mask from the regions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       Developer note
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#convenience-routine-for-plotting-a-spectrum-and-highlighting-the-mask">
     Convenience routine for plotting a spectrum and highlighting the mask
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       Developer notes
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fitting">
   Fitting
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Developer notes
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Developer note
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#looking-at-the-fit-results">
   Looking at the fit results
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     Developer note
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     Developer note
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     Developer note
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#input-and-output-compound-models">
     Input and output compound models
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id12">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-residuals">
     Plot the residuals
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-individual-components">
     Plot individual components
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id13">
       Developer notes
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="draft-advanced-composite-spectral-model-fitting">
<h1>Draft: Advanced Composite spectral model fitting<a class="headerlink" href="#draft-advanced-composite-spectral-model-fitting" title="Permalink to this headline">¶</a></h1>
<p><strong>Use case:</strong> Fitting the complex continuum around Lyman-alpha in the spectrum of an active galaxy NGC 5548.<br>
<strong>Data:</strong> 3-column ECSV file with units for each column.<br>
<strong>Tools:</strong> specutils, numpy.<br>
<strong>Cross-intrument:</strong> all instruments.<br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this example, we are fitting the complex continuum around Lyman-alpha in the spectrum of an active galaxy (NGC 5548). This involves a powerlaw, extinction, emission lines of various widths and absorption lines. Only certain regions of the spectrum (away from strong absorption lines) are fit. The model has some fixed and some free parameters, as well as parameters that are linked together. We are using the Astropy compound-model machinery to add fit all the components simultaneously.</p>
<p>The example makes only partial use of specutils. It reads the data into the Spectrum1D data structure. However, when we get to actually fitting the model, we are just grabbing the numpy arrays (without units, because that caused some errors).</p>
<div class="section" id="developer-notes">
<h3>Developer Notes<a class="headerlink" href="#developer-notes" title="Permalink to this headline">¶</a></h3>
<p>Todo:</p>
<ul class="simple">
<li><p>Move useful stuff from fit_functions upstream to astropy?</p></li>
<li><p>Use units and quantities all the way through</p></li>
<li><p>Illustrate fixing and freeing parameters</p></li>
<li><p>Illustrate locking and unlocking parameters</p></li>
<li><p>Figure out how to introspect the tied parameters (may need a helper class for Astropy modeling)</p></li>
<li><p>This model doesn’t fit very well. Change the example.</p></li>
<li><p>The covariance cell is returning nothing. Is that intended?</p>
<ul>
<li><p>might be nice to show a triangle diagram of convariances</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">specutils</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">astropy.modeling.fitting</span> <span class="k">as</span> <span class="nn">fitting</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">QTable</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import astropy</span>
<span class="c1"># import matplotlib</span>
<span class="c1"># print(&quot;Astropy Version: &quot;,astropy.__version__)</span>
<span class="c1"># print(&quot;Numpy Version: &quot;,np.__version__)</span>
<span class="c1"># print(&quot;Specutils Version: &quot;,specutils.__version__)</span>
<span class="c1"># print(&quot;Matplotlib Version: &quot;,matplotlib.__version__)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id1">
<h4>Developer notes:<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>Versions:</p>
<ul class="simple">
<li><p>Astropy Version:  3.2.3</p></li>
<li><p>Numpy Version:  1.17.3</p></li>
<li><p>Specutils Version:  0.6</p></li>
<li><p>Matplotlib Version:  3.1.2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># inline -- noninteractive cells, notebook -- interactive cells </span>
<span class="o">%</span><span class="k">matplotlib</span> inline 
<span class="c1"># %matplotlib notebook</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format =&#39;retina&#39; # Mackbook optimization
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="data-input">
<h2>Data input<a class="headerlink" href="#data-input" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>spectrum: simple 3-column ECSV file with units for each column</p></li>
<li><p>wavelength regions to be included in fit: simple 2-column ASCII file with lower &amp; upper bounds</p></li>
</ul>
<p>First set up pathnames.</p>
<div class="section" id="developer-note">
<h3>Developer note<a class="headerlink" href="#developer-note" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>These data files are small ASCII files, so they are in the github repo with the notebook</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datafile</span> <span class="o">=</span> <span class="s2">&quot;./n5548_mean_g130mb4.ecsv&quot;</span>
<span class="n">regionsfile</span> <span class="o">=</span> <span class="s2">&quot;./n5548_lyalpha_sample.dat&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Read the tables using astropy’s QTable, so that we preserve the units.</p>
</div>
<div class="section" id="id2">
<h3>Developer notes<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>It would be good if this example provided an example of recommended practice for encoding uncertainties in tables. Questions:</p>
<ul class="simple">
<li><p>Should the uncertainties have units?</p></li>
<li><p>Seems like the name “uncertainty” is generally understood to mean standard deviation (or the equivalent). So if one wants to have these be, e.g., variance, the user should name the column <code class="docutils literal notranslate"><span class="pre">variance</span></code>.</p></li>
<li><p>It’s a bit ugly to have to either add a table column to make these an astropy uncertainty object, or just store that as as a separate variable.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.ecsv&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><i>QTable length=3</i>
<table id="table140234710502944" class="table-striped table-bordered table-condensed">
<thead><tr><th>wavelength</th><th>flux</th><th>uncertainty</th></tr></thead>
<thead><tr><th>Angstrom</th><th>erg / (Angstrom cm2 s)</th><th>erg / (Angstrom cm2 s)</th></tr></thead>
<thead><tr><th>float64</th><th>float64</th><th>float64</th></tr></thead>
<tr><td>1139.99559</td><td>4.39553486807e-14</td><td>1.12651909249e-15</td></tr>
<tr><td>1140.03439</td><td>4.15510398254e-14</td><td>1.09891679648e-15</td></tr>
<tr><td>1140.07320</td><td>4.31114724961e-14</td><td>1.12382203631e-15</td></tr>
</table></div></div></div>
</div>
</div>
</div>
<div class="section" id="put-the-spectrum-into-a-spectrum1d-object">
<h2>Put the spectrum into a Spectrum1D object<a class="headerlink" href="#put-the-spectrum-into-a-spectrum1d-object" title="Permalink to this headline">¶</a></h2>
<p>We need to convert the uncertainty into an astropy uncertainty object first.</p>
<div class="section" id="id3">
<h3>Developer notes<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>I think it might be simpler to hide the uncertainty type as options to the Spectrum1D call, defaulting to standard-deviation.</p>
<p>For example…I first tried what I thought would make sense:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stdev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">])</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">specutils</span><span class="o">.</span><span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>
                                <span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span><span class="n">uncertainty</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stdev&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>That raises an <code class="docutils literal notranslate"><span class="pre">IncompatibleUncertaintiesException</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uncertainty</span> <span class="o">=</span> <span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">])</span>
<span class="n">spectrum</span> <span class="o">=</span> <span class="n">specutils</span><span class="o">.</span><span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">],</span>
                                <span class="n">flux</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Spectrum1D (length=6058)
flux:             [ 4.3955e-14 erg / (Angstrom cm2 s), ..., 4.2905e-14 erg / (Angstrom cm2 s) ],  mean=6.9511e-14 erg / (Angstrom cm2 s)
spectral axis:    [ 1140.0 Angstrom, ..., 1375.0 Angstrom ],  mean=1257.5 Angstrom
uncertainty:      [ StdDevUncertainty(1.12651909e-15), ..., StdDevUncertainty(6.8110986e-16) ]
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="read-in-the-spectral-regions">
<h2>Read in the spectral regions<a class="headerlink" href="#read-in-the-spectral-regions" title="Permalink to this headline">¶</a></h2>
<p>Convert these into specutils SpectralRegions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regionstab</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">regionsfile</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
<span class="n">subregions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x0</span><span class="p">,</span><span class="n">x1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">regionstab</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">],</span><span class="n">regionstab</span><span class="p">[</span><span class="s1">&#39;col2&#39;</span><span class="p">]):</span>
    <span class="n">subregions</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">x0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">,</span> <span class="n">x1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)]</span>
<span class="n">regions</span><span class="o">=</span><span class="n">specutils</span><span class="o">.</span><span class="n">SpectralRegion</span><span class="p">(</span><span class="n">subregions</span><span class="p">)</span>
<span class="n">regions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Spectral Region, 24 sub-regions:
  (1145.83 Angstrom, 1151.33 Angstrom) 
  (1152.88 Angstrom, 1187.88 Angstrom) 
  (1193.68 Angstrom, 1197.7 Angstrom)  
  (1197.3 Angstrom, 1198.53 Angstrom)  
  (1201.38 Angstrom, 1205.38 Angstrom) 
  (1207.08 Angstrom, 1208.36 Angstrom) 
  (1210.58 Angstrom, 1213.58 Angstrom) 
  (1217.38 Angstrom, 1218.75 Angstrom) 
  (1220.3 Angstrom, 1221.7 Angstrom)   
  (1223.02 Angstrom, 1224.08 Angstrom) 
  (1225.74 Angstrom, 1227.2 Angstrom)  
  (1227.86 Angstrom, 1228.35 Angstrom) 
  (1229.08 Angstrom, 1230.38 Angstrom) 
  (1236.68 Angstrom, 1238.0 Angstrom)  
  (1238.95 Angstrom, 1239.53 Angstrom) 
  (1240.42 Angstrom, 1242.24 Angstrom) 
  (1242.93 Angstrom, 1249.88 Angstrom) 
  (1250.68 Angstrom, 1253.17 Angstrom) 
  (1254.04 Angstrom, 1254.32 Angstrom) 
  (1256.36 Angstrom, 1256.47 Angstrom) 
  (1263.37 Angstrom, 1263.64 Angstrom) 
  (1264.28 Angstrom, 1270.0 Angstrom)  
  (1362.51 Angstrom, 1369.56 Angstrom) 
  (1370.15 Angstrom, 1372.76 Angstrom) 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-a-mask-from-the-regions">
<h2>Create a mask from the regions<a class="headerlink" href="#create-a-mask-from-the-regions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3>Developer note<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>We could probably do the whole workflow extracting regions, but I think it would end up being uglier than using a mask.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mask_from_regions</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">regions</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
        <span class="n">submask</span> <span class="o">=</span> <span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">&gt;</span><span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">&lt;=</span><span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="n">submask</span>
    <span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_from_regions</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">regions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False True
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_3089/3955972367.py:2: DeprecationWarning: `np.bool` is a deprecated alias for the builtin `bool`. To silence this warning, use `bool` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.bool_` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  mask = np.zeros(spectrum.spectral_axis.shape,dtype=np.bool)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="convenience-routine-for-plotting-a-spectrum-and-highlighting-the-mask">
<h2>Convenience routine for plotting a spectrum and highlighting the mask<a class="headerlink" href="#convenience-routine-for-plotting-a-spectrum-and-highlighting-the-mask" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id5">
<h3>Developer notes<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>I think this way of illustrating the mask is reasonably elegant. I sort of like it better than having the shaded regions extend all the way up to the top. (I do that later when showing the residuals, for comparison).</p></li>
<li><p>Another way to do it might be to change the line color to grey, or change the opacity, in the masked regions, but that would be harder to implement and probably slower.</p></li>
<li><p>This routine exposes both a benefit of using units and Spectrum1D – you can automatically put the units on the axis</p></li>
<li><p>This also exposes a limitation: Right now, while quantity_support() puts the units on the axis automaticall, it doesn’t put the label. It is the standard convention to give <code class="docutils literal notranslate"><span class="pre">label</span> <span class="pre">(units)</span></code> when labeling axes. The trick used here of adding in the label using <code class="docutils literal notranslate"><span class="pre">get_label()</span></code> and <code class="docutils literal notranslate"><span class="pre">set_label()</span></code> is liable to be too obscure for most users.</p></li>
<li><p>Are we going to keep all visualization for specviz, or should there be some tools for visualization in specutils?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                  <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">plot_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">mask_color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">mask_alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">spectrum</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_mask</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">spectrum</span><span class="o">.</span><span class="n">flux</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">mask_alpha</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">mask_color</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength (&quot;</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Flux (&quot;</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylabel</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plot_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;NGC 5548 spectrum and mask to be used for fitting the model&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/specfit_demo_3_18_0.png" src="../../_images/specfit_demo_3_18_0.png" />
</div>
</div>
<h1>First guess model</h1>
<p>The model is imported directly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">n5548_models</span> <span class="k">as</span> <span class="nn">models</span>
</pre></div>
</div>
</div>
</div>
<p>The .py module defined above builds one or more instances of a special type of function defined in the astropy.modeling.models package, called a “compound model”.</p>
<p>A compound model is just a combination of astropy.modeling.models functions, using as combination operators such things as addition, multiplication, and others.</p>
<p>Example:</p>
<p><code>compound_model = models.PowerLaw1D(1.,1.) + models.Gaussian1D(1.,1.,1.)</code></p>
<p>will create an instance of a compound model with two components.</p>
<p>An actual, importable model definition will look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">custom_models</span> <span class="kn">import</span> <span class="n">gaussian</span><span class="p">,</span> <span class="n">powerlaw</span><span class="p">,</span> <span class="n">ccmext</span>

<span class="n">model1</span> <span class="o">=</span> \
    <span class="n">powerlaw</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;powerlaw1&#39;</span><span class="p">,</span>
             <span class="n">amp</span> <span class="o">=</span>   <span class="mf">6.586200E-14</span><span class="p">,</span>
             <span class="n">x_0</span> <span class="o">=</span>   <span class="mf">1000.0</span><span class="p">,</span>
             <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.4819233</span><span class="p">,</span>
             <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;amp&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.00E-11</span><span class="p">),</span>
                       <span class="s1">&#39;x_0&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.00E-11</span><span class="p">),</span>
                       <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">)},</span>
             <span class="n">fixed</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_0&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
             <span class="p">)</span> \
<span class="o">+</span> \
    <span class="n">gaussian</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;C III 1176&#39;</span><span class="p">,</span>
             <span class="n">norm</span> <span class="o">=</span> <span class="mf">2.000000E-14</span><span class="p">,</span>
             <span class="n">mean</span> <span class="o">=</span> <span class="mf">1195.006</span><span class="p">,</span>
             <span class="n">fwhm</span> <span class="o">=</span> <span class="mf">861.4926</span><span class="p">,</span>
             <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.00E-10</span><span class="p">),</span>
                       <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1000.</span><span class="p">,</span> <span class="mf">2000.</span><span class="p">),</span>
                       <span class="s1">&#39;fwhm&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1000.</span><span class="p">,</span> <span class="mf">2000.</span><span class="p">),</span>
                       <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)},</span>
             <span class="n">fixed</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="s1">&#39;fwhm&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
             <span class="p">)</span> \
</pre></div>
</div>
<p>For this exercise, we pick the model named ‘model1’:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compound_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">model1</span>
</pre></div>
</div>
</div>
</div>
<p>The module uses some special function types, defined by overriding the standard functions in asytropy.modeling.models in module custom_models.</p>
<p>This overriding is necessary because the spectral components in specfit do not conform with the standards defined in astropy.modeling.models. For example, a Gaussian in specfit is defined by an amplitude, a central wavelength, a FWHM in km/s, and a skweness parameter. In astropy.modeling.models a Gaussian is defined by an amplitude, a central wavelength, and a width in units consistent with the units of the central wavelength. And no skewness parameter. These incompatibilities are addressed by the sub-classes defined in the fit_functions module.</p>
</div>
<div class="section" id="id6">
<h3>Developer notes<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Seems useful to have a Gaussian with skew as an Astropy model, so that should probably be moved upstream.</p></li>
<li><p>Not sure about the FWHM. It’s probably cleaner for that to be the width parameter when there is skewness, since it’s more intuitive than standard deviation.</p></li>
<li><p>The print statement for the compound model below is okay but not great. Might be worth having a pretty print for notebooks that makes this more readable.</p>
<ul>
<li><p>This print statement does not indicate which parameters are fixed or floating</p></li>
<li><p>It does not indicate which parameters are tied to others and how</p></li>
<li><p>There is an ellipsis in the table at the end</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">compound_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: CompoundModel
Inputs: (&#39;x&#39;,)
Outputs: (&#39;y&#39;,)
Model set size: 1
Expression: [0] * [1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12] + [13] + [14] + [15] + [16] + [17] + [18] + [19] + [20] + [21]
Components: 
    [0]: &lt;powerlaw(amplitude=0., x_0=1000., alpha=0.4819233, name=&#39;powerlaw1&#39;)&gt;

    [1]: &lt;ccmext(ebmv=0.01713, rv=3.1, name=&#39;extinction&#39;)&gt;

    [2]: &lt;gaussian(norm=0., mean=1195.006, fwhm=861.4926, skew=1., name=&#39;C III 1176&#39;)&gt;

    [3]: &lt;gaussian(norm=0., mean=1226.392, fwhm=861.4926, skew=1., name=&#39;Si III 1206&#39;)&gt;

    [4]: &lt;gaussian(norm=0., mean=1236.729, fwhm=255.4998, skew=1., name=&#39;Ly alpha - NLR, ILR,  medium,  very broad&#39;)&gt;

    [5]: &lt;gaussian(norm=0., mean=1235.996, fwhm=861.4926, skew=1., name=&#39;gaussian5&#39;)&gt;

    [6]: &lt;gaussian(norm=0., mean=1235.138, fwhm=3040.59, skew=1., name=&#39;gaussian6&#39;)&gt;

    [7]: &lt;gaussian(norm=0., mean=1231.589, fwhm=8133.099, skew=1., name=&#39;gaussian7&#39;)&gt;

    [8]: &lt;gaussian(norm=0., mean=1237.643, fwhm=18183.71, skew=1., name=&#39;gaussian8&#39;)&gt;

    [9]: &lt;gaussian(norm=0., mean=1259.753, fwhm=255.4998, skew=1., name=&#39;N V - 2 NLR, 2 ILR, 2 medium, 1 very broad&#39;)&gt;

    [10]: &lt;gaussian(norm=0., mean=1263.803, fwhm=255.4998, skew=1., name=&#39;gaussian10&#39;)&gt;

    [11]: &lt;gaussian(norm=0., mean=1259.533, fwhm=861.4926, skew=1., name=&#39;gaussian11&#39;)&gt;

    [12]: &lt;gaussian(norm=0., mean=1263.582, fwhm=861.4926, skew=1., name=&#39;gaussian12&#39;)&gt;

    [13]: &lt;gaussian(norm=0., mean=1258.659, fwhm=3040.59, skew=1., name=&#39;gaussian13&#39;)&gt;

    [14]: &lt;gaussian(norm=0., mean=1262.705, fwhm=3040.59, skew=1., name=&#39;gaussian14&#39;)&gt;

    [15]: &lt;gaussian(norm=0., mean=1255.042, fwhm=8133.099, skew=1., name=&#39;gaussian15&#39;)&gt;

    [16]: &lt;gaussian(norm=0., mean=1259.077, fwhm=8133.099, skew=1., name=&#39;gaussian16&#39;)&gt;

    [17]: &lt;gaussian(norm=0., mean=1263.24, fwhm=18183.71, skew=1., name=&#39;gaussian17&#39;)&gt;

    [18]: &lt;gaussian(norm=-0., mean=1194., fwhm=3683.102, skew=0.1849483, name=&#39;C III broad absorption&#39;)&gt;

    [19]: &lt;gaussian(norm=-0., mean=1235., fwhm=3683.102, skew=0.1849483, name=&#39;Ly alpha broad absorption&#39;)&gt;

    [20]: &lt;gaussian(norm=-0., mean=1258., fwhm=3683.102, skew=0.1849483, name=&#39;N V broad absorption&#39;)&gt;

    [21]: &lt;gaussian(norm=-0., mean=1262.044, fwhm=3683.102, skew=0.1849483, name=&#39;N V broad absorption - 2&#39;)&gt;
Parameters:
    amplitude_0 x_0_0   alpha_0   ebmv_1 ... mean_21  fwhm_21   skew_21 
    ----------- ------ --------- ------- ... -------- -------- ---------
     6.5862e-14 1000.0 0.4819233 0.01713 ... 1262.044 3683.102 0.1849483
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plot_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">compound_model</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial model&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Data and initial model&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/specfit_demo_3_27_0.png" src="../../_images/specfit_demo_3_27_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="fitting">
<h1>Fitting<a class="headerlink" href="#fitting" title="Permalink to this headline">¶</a></h1>
<p>We have the data and the model, now we need to fit one to the other. We can use that by instantiating an Astropy fitter, in this case the <code class="docutils literal notranslate"><span class="pre">LevMarLSQFitter</span></code> which uses the Levenberg-Marquardt algorithm for least-squares fitting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>In this example, we have access to the errors for the data points, so we can use their inverse as weights for the fit. To include the mask, which is <code class="docutils literal notranslate"><span class="pre">1</span></code> for pixels we want to fit and <code class="docutils literal notranslate"><span class="pre">0</span></code> for pixels we want to exclude, we take <span class="math notranslate nohighlight">\(\rm {mask} / \sigma\)</span>, as the weight to give to the fitter.</p>
<div class="section" id="id7">
<h2>Developer notes<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Because the compound model fitting didn’t work out of the box feeding it the Specutils <code class="docutils literal notranslate"><span class="pre">spectral_axis</span></code> and <code class="docutils literal notranslate"><span class="pre">flux</span></code> Quanitities, I’m getting rid of the units. In conversation, it seems like there is some machinery for removing the units and putting them back in <code class="docutils literal notranslate"><span class="pre">fit_line</span></code> (which is more general than just fitting a line), but I didn’t think to look there.</p></li>
<li><p>While it agrees with the scipy fitter conventions, I think it is quite confusing to call <span class="math notranslate nohighlight">\(w = 1/\sigma\)</span> the <em>weight</em>. I checked the code and for this fitter, indeed it is squaring this to use as the weight, so the calculation is correct. But I think it is more common to think of the correct weight as being <span class="math notranslate nohighlight">\(w = 1/\sigma^2\)</span> for least-squares fitting. I’ve now gone down the rabbit hole of trying to double-check that Astropy is doing the weighting correctly twice because of this unusual use of the word “weight.”</p></li>
<li><p>Nadia Dencheva is going to check that the non-least-squares fitters are using weight when their instructions say use <span class="math notranslate nohighlight">\(1/\sigma\)</span> – i.e. are they squaring it or not before computing the merit function?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wavelength</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">value</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span>
<span class="n">inverse_sigma</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="o">/</span><span class="n">spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">array</span>
</pre></div>
</div>
</div>
</div>
<p>To do the fit, call the fitter instance with the data, weights, and some control parameters if needed. Let’s do some timing as well:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">fit_result</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">compound_model</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">inverse_sigma</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mf">1.E-30</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Elapsed time:  7.257724285125732
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>Developer note<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>I’m not sure how to interpret the fit_info message below that</p></li>
</ul>
<div class="highlight-Both notranslate"><div class="highlight"><pre><span></span> are at most 0.0000001```
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fitter</span><span class="o">.</span><span class="n">fit_info</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Both actual and predicted relative reductions in the sum of squares
  are at most 0.000000
</pre></div>
</div>
</div>
</div>
<p>The result is another instance of a compound model, with the fitted values set into the  parameter values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">fit_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: CompoundModel
Inputs: (&#39;x&#39;,)
Outputs: (&#39;y&#39;,)
Model set size: 1
Expression: [0] * [1] + [2] + [3] + [4] + [5] + [6] + [7] + [8] + [9] + [10] + [11] + [12] + [13] + [14] + [15] + [16] + [17] + [18] + [19] + [20] + [21]
Components: 
    [0]: &lt;powerlaw(amplitude=0., x_0=1000., alpha=1.54475959, name=&#39;powerlaw1&#39;)&gt;

    [1]: &lt;ccmext(ebmv=0.07956856, rv=3.1, name=&#39;extinction&#39;)&gt;

    [2]: &lt;gaussian(norm=0., mean=1195.006, fwhm=861.4926, skew=1., name=&#39;C III 1176&#39;)&gt;

    [3]: &lt;gaussian(norm=0., mean=1226.392, fwhm=861.4926, skew=1., name=&#39;Si III 1206&#39;)&gt;

    [4]: &lt;gaussian(norm=0., mean=1236.729, fwhm=255.4998, skew=1., name=&#39;Ly alpha - NLR, ILR,  medium,  very broad&#39;)&gt;

    [5]: &lt;gaussian(norm=0., mean=1235.996, fwhm=861.4926, skew=1., name=&#39;gaussian5&#39;)&gt;

    [6]: &lt;gaussian(norm=0., mean=1235.138, fwhm=3040.59, skew=1., name=&#39;gaussian6&#39;)&gt;

    [7]: &lt;gaussian(norm=0., mean=1231.589, fwhm=8133.099, skew=1., name=&#39;gaussian7&#39;)&gt;

    [8]: &lt;gaussian(norm=0., mean=1237.643, fwhm=18183.71, skew=1., name=&#39;gaussian8&#39;)&gt;

    [9]: &lt;gaussian(norm=0., mean=1259.753, fwhm=255.4998, skew=1., name=&#39;N V - 2 NLR, 2 ILR, 2 medium, 1 very broad&#39;)&gt;

    [10]: &lt;gaussian(norm=0., mean=1263.80310589, fwhm=255.4998, skew=1., name=&#39;gaussian10&#39;)&gt;

    [11]: &lt;gaussian(norm=0., mean=1259.53307183, fwhm=861.4926, skew=1., name=&#39;gaussian11&#39;)&gt;

    [12]: &lt;gaussian(norm=0., mean=1263.58247065, fwhm=861.4926, skew=1., name=&#39;gaussian12&#39;)&gt;

    [13]: &lt;gaussian(norm=0., mean=1258.65873293, fwhm=3040.59, skew=1., name=&#39;gaussian13&#39;)&gt;

    [14]: &lt;gaussian(norm=0., mean=1262.70532076, fwhm=3040.59, skew=1., name=&#39;gaussian14&#39;)&gt;

    [15]: &lt;gaussian(norm=0., mean=1255.04214933, fwhm=8133.099, skew=1., name=&#39;gaussian15&#39;)&gt;

    [16]: &lt;gaussian(norm=0., mean=1259.07710984, fwhm=8133.099, skew=1., name=&#39;gaussian16&#39;)&gt;

    [17]: &lt;gaussian(norm=0., mean=1280.99893106, fwhm=8133.099, skew=1., name=&#39;gaussian17&#39;)&gt;

    [18]: &lt;gaussian(norm=-0., mean=1194., fwhm=3683.102, skew=0.1849483, name=&#39;C III broad absorption&#39;)&gt;

    [19]: &lt;gaussian(norm=0., mean=1235., fwhm=3683.102, skew=0.1849483, name=&#39;Ly alpha broad absorption&#39;)&gt;

    [20]: &lt;gaussian(norm=0., mean=1258., fwhm=3683.102, skew=0.1849483, name=&#39;N V broad absorption&#39;)&gt;

    [21]: &lt;gaussian(norm=0., mean=1262.04447, fwhm=3683.102, skew=0.1849483, name=&#39;N V broad absorption - 2&#39;)&gt;
Parameters:
         amplitude_0       x_0_0       alpha_0      ... fwhm_21   skew_21 
    ---------------------- ------ ----------------- ... -------- ---------
    1.3444821251750214e-13 1000.0 1.544759588994028 ... 3683.102 0.1849483
</pre></div>
</div>
</div>
</div>
<p>Lets print some derived results:</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="looking-at-the-fit-results">
<h1>Looking at the fit results<a class="headerlink" href="#looking-at-the-fit-results" title="Permalink to this headline">¶</a></h1>
<p>Create a little routine to estimate chisq. It needs to compute the number of degrees of freedom taking into account the mask and the number of free parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">chisq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">nfree</span><span class="p">):</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">err</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chisq</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">npoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chisq</span> <span class="o">/</span> <span class="p">(</span><span class="n">npoints</span> <span class="o">-</span> <span class="n">nfree</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> 
</pre></div>
</div>
</div>
</div>
<p>Figure out how many fixed and free parameters there are.</p>
<div class="section" id="id9">
<h2>Developer note<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>This is pretty ugly and involved. The fitter knows how many data points and free parameters there are, but I don’t think it passes that information along as “metadata” to the fit results. The fit_info is a dictionary returned from <code class="docutils literal notranslate"><span class="pre">scipy.optimize.leastsq</span></code>, but it doesn’t have the number of free parameters.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;fixed&#39;</span> <span class="ow">in</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">parameter_constraints</span><span class="p">:</span>
    <span class="n">fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fit_result</span><span class="o">.</span><span class="n">fixed</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">n_fixed_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">n_fixed_parameters</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">if</span> <span class="s1">&#39;tied&#39;</span> <span class="ow">in</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">parameter_constraints</span><span class="p">:</span>
    <span class="n">tie</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fit_result</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">n_tied_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tie</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">n_tied_parameters</span> <span class="o">=</span> <span class="mi">0</span>
    
<span class="n">n_free_par</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_result</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_fixed_parameters</span> <span class="o">-</span> <span class="n">n_tied_parameters</span>
</pre></div>
</div>
</div>
</div>
<p>Print out <span class="math notranslate nohighlight">\(\chi^2\)</span> and other relevant info.</p>
</div>
<div class="section" id="id10">
<h2>Developer note<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>This kind of thing ought to be standard output</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chisq_in</span> <span class="o">=</span> <span class="n">chisq</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">compound_model</span><span class="p">,</span> <span class="n">n_free_par</span><span class="p">)</span>
<span class="n">chisq_out</span> <span class="o">=</span> <span class="n">chisq</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">,</span> <span class="n">n_free_par</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chisq from input model:  </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chisq_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chisq from output model: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chisq_out</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total data points: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavelength</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data points in wavelength ranges: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of free parameters: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">n_free_par</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of iterations: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fit_info</span><span class="p">[</span><span class="s1">&#39;nfev&#39;</span><span class="p">])</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Fit engine took </span><span class="si">%d</span><span class="s2"> elapsed seconds.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>chisq from input model:  19.531387
chisq from output model: 10.393390
Total data points: 6058
Data points in wavelength ranges: 2318
Number of free parameters: 83
Number of iterations: 596
Fit engine took 7 elapsed seconds.
</pre></div>
</div>
</div>
</div>
<p>Errors associated with each free parameter from the covariance matrix.</p>
</div>
<div class="section" id="id11">
<h2>Developer note<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>This is empty. But it actually is in the fit_info from this fitter, so we could grab it.</p></li>
<li><p>It would be nice in a more advanced version of this notebook to show someone how to plot the error ellipses in a triangle (corner) plot, which is a good way to visualize correlations between pairs of parameters.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fit_info</span><span class="p">[</span><span class="s1">&#39;param_cov&#39;</span><span class="p">]</span>

<span class="n">param_errors</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># extract variances from covariance matrix</span>
    <span class="n">fit_errors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">fixed</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
        <span class="n">tied</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">tied</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tied</span><span class="p">:</span>
            <span class="n">fit_errors</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            
    <span class="c1"># map errors to input model&#39;s components and parameters.</span>
    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">fit_errors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">target_param_name</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">_param_map</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
        <span class="n">component_name</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">_submodels_names</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">param_errors</span><span class="p">[(</span><span class="n">component_name</span><span class="p">,</span> <span class="n">target_param_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fit_errors</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">param_errors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{}
</pre></div>
</div>
</div>
</div>
<h1>Plots</h1></div>
<div class="section" id="input-and-output-compound-models">
<h2>Input and output compound models<a class="headerlink" href="#input-and-output-compound-models" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id12">
<h3>Developer notes<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>A fancy, but <em>very</em> useful interactive version of this plot might have the following features</p>
<ul>
<li><p>Zoom &amp; pan, etc (could get that by using %matplotlib notebook, but scrolling is a pain with that)</p></li>
<li><p>Ability to toggle from curves to histograms for the data</p></li>
<li><p>Ability to toggle on and off the mask, change alpha, etc</p></li>
<li><p>Ability to toggle on and off errorbars on the data, change alpha, etc</p></li>
<li><p>Hover information: data, residual, percent contribution to chisq for that one point</p></li>
<li><p>Ability to toggle on and off individual components of the compound model</p>
<ul>
<li><p>That wouldn’t be all that useful in this example, since it’s better to see them on top of the powerlaw*extinction, but that’s a pretty special use case.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plot_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">compound_model</span><span class="p">(</span><span class="n">wavelength</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;initial model&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">(</span><span class="n">wavelength</span><span class="p">),</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;fitted model&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">1200</span><span class="p">,</span><span class="mi">1275</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mf">7e-13</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Data and models&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/specfit_demo_3_49_0.png" src="../../_images/specfit_demo_3_49_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="plot-the-residuals">
<h2>Plot the residuals<a class="headerlink" href="#plot-the-residuals" title="Permalink to this headline">¶</a></h2>
<p>Focus in on the most interesting region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.e-13</span><span class="p">,</span> <span class="mf">2.e-13</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span><span class="n">flux</span><span class="o">-</span><span class="n">compound_model</span><span class="p">(</span><span class="n">wavelength</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span><span class="n">flux</span><span class="o">-</span><span class="n">fit_result</span><span class="p">(</span><span class="n">wavelength</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">1185.</span><span class="p">,</span> <span class="mf">1270.</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\rm \AA$)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Flux ($\rm erg\, cm^{-2}\, s^{-1}\, \AA^{-1}$)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/specfit_demo_3_51_0.png" src="../../_images/specfit_demo_3_51_0.png" />
</div>
</div>
</div>
<div class="section" id="plot-individual-components">
<h2>Plot individual components<a class="headerlink" href="#plot-individual-components" title="Permalink to this headline">¶</a></h2>
<p>Here we plot them on top of the basic powerlaw*extinction</p>
<div class="section" id="id13">
<h3>Developer notes<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>I was trying to label or otherwise indicate which ones are tied together, but it seems like this information gets lost because because tying parameters is just done by passing a function. It might be better for Astropy to have a base class that people can use that would have the name of the referenced parameter as an attribute and has a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method. Then one could at least recommend that people use this when tying parameters, to facilitate later introspection.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plot_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">(</span><span class="n">wavelength</span><span class="p">),</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;fitted model&#39;</span><span class="p">)</span>
<span class="n">plext</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;powerlaw1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;extinction&#39;</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span><span class="n">plext</span><span class="p">(</span><span class="n">wavelength</span><span class="p">),</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;powerlaw + extinction&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">fit_result</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;powerlaw1&#39;</span> <span class="ow">and</span> <span class="n">component</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;extinction&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,(</span><span class="n">plext</span><span class="o">+</span><span class="n">component</span><span class="p">)(</span><span class="n">wavelength</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">1200</span><span class="p">,</span><span class="mi">1275</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mf">9e-13</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Data and models&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/specfit_demo_3_53_0.png" src="../../_images/specfit_demo_3_53_0.png" />
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/composite_model_fitting"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../background_estimation_imaging/Imaging%20Sky%20Background%20Estimation.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Imaging Sky Background Estimation</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">MAST Query Tutorial for NIRSpec Users</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By STScI<br/>
    
        &copy; Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>